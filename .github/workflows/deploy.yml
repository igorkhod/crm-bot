name: Deploy Psytech Bot

on:
  push:
    branches: [ "main" ]

# üëá –¥–∞—ë–º —Ç–æ–∫–µ–Ω—É –ø—Ä–∞–≤–æ –ø–∏—Å–∞—Ç—å —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
permissions:
  contents: write

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1) –ö–æ–¥
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      # 2) –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ PROJECT_MAP.full.md
      - name: Update PROJECT_MAP.full.md
        run: |
          python scripts/update_project_map.py
          git config --global user.name "github-actions"
          git config --global user.email "actions@github.com"
          git add crm2/PROJECT_MAP.full.md
          git commit -m "chore: auto-update PROJECT_MAP.full.md" || echo "No changes"
          git push

      # 3) –£–ø–∞–∫–æ–≤—ã–≤–∞–µ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –≤ tar.gz (–±–µ–∑ .git)
      - name: Make tarball (git archive)
        run: |
          git archive --format=tar.gz -o app.tgz HEAD
          ls -lh app.tgz

      # 4) –ö–æ–ø–∏—Ä—É–µ–º –∞—Ä—Ö–∏–≤ –Ω–∞ VPS
      - name: Upload tarball via SCP
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_SSH_PORT || 22 }}
          source: app.tgz
          target: /opt/psytech-bot/

      # 5) –†–∞—Å–ø–∞–∫–æ–≤—ã–≤–∞–µ–º, —Å—Ç–∞–≤–∏–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏, –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–∏—Å
      - name: Extract & restart (SSH)
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_SSH_PORT || 22 }}
          script: |
            set -e
            cd /opt/psytech-bot
            mkdir -p app
            tar xzf app.tgz -C app
            rm -f app.tgz

            # –Ω–∞–π–¥—ë–º requirements.txt –≤ –∏–∑–≤–µ—Å—Ç–Ω—ã—Ö –º–µ—Å—Ç–∞—Ö
            REQ=""
            for CAND in app/requirements.txt app/crm2/requirements.txt app/crm2/app/requirements.txt app/*/requirements.txt app/**/requirements.txt; do
              [ -f "$CAND" ] && { REQ="$CAND"; break; }
            done
            if [ -n "$REQ" ]; then
              echo "Using requirements: $REQ"
              /opt/psytech-bot/venv/bin/pip install -r "$REQ"
            else
              echo "‚ö†Ô∏è requirements.txt –Ω–µ –Ω–∞–π–¥–µ–Ω ‚Äî –ø—Ä–æ–ø—É—Å–∫–∞—é —É—Å—Ç–∞–Ω–æ–≤–∫—É –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π"
            fi

            sudo -n systemctl restart psytech-bot.service
            sudo -n systemctl is-active --quiet psytech-bot.service && echo "‚úÖ Bot running"
            journalctl -u psytech-bot -n 40 --no-pager || true
