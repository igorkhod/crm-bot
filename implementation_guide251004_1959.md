# üìã –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –≤–Ω–µ–¥—Ä–µ–Ω–∏—é –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π

## ‚úÖ –ß—Ç–æ –±—ã–ª–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ

### 1. **–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –º–æ–¥—É–ª—è –¥–æ–º–∞—à–Ω–∏—Ö –∑–∞–¥–∞–Ω–∏–π**
- –í `panel.py` –∫–Ω–æ–ø–∫–∞ "üìö –î–æ–º–∞—à–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è" —Ç–µ–ø–µ—Ä—å –≤—ã–∑—ã–≤–∞–µ—Ç FSM-–æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤–º–µ—Å—Ç–æ –∑–∞–≥–ª—É—à–∫–∏

### 2. **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω —Ü–∏–∫–ª —Å—Ç–∞—Ç—É—Å–æ–≤ –ø–æ—Å–µ—â–∞–µ–º–æ—Å—Ç–∏**
- –£–±—Ä–∞–Ω –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —Å—Ç–∞—Ç—É—Å `expelled` (–Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞–ª CHECK constraint –ë–î)
- –¶–∏–∫–ª —Ç–µ–ø–µ—Ä—å: `–ø—É—Å—Ç–æ ‚Üí present ‚Üí absent ‚Üí late ‚Üí –ø—É—Å—Ç–æ`
- –û–±–Ω–æ–≤–ª–µ–Ω—ã –∏–∫–æ–Ω–∫–∏: ‚úÖ (present) ‚Üí ‚ùå (absent) ‚Üí ‚è∞ (late) ‚Üí ‚¨úÔ∏è (–ø—É—Å—Ç–æ)

### 3. **–°–æ–∑–¥–∞–Ω —Å–µ—Ä–≤–∏—Å–Ω—ã–π —Å–ª–æ–π –¥–ª—è attendance**
- –ù–æ–≤—ã–π —Ñ–∞–π–ª `services/attendance.py` —Å —Ñ—É–Ω–∫—Ü–∏—è–º–∏:
  - `get_sessions_near()` - –∑–∞–Ω—è—Ç–∏—è –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ N –¥–Ω–µ–π
  - `get_present_users()` - –∫—Ç–æ –æ—Ç–º–µ—á–µ–Ω "–ø—Ä–∏—Å—É—Ç—Å—Ç–≤–æ–≤–∞–ª"
  - `get_not_yet_delivered()` - –∫—Ç–æ –µ—â—ë –Ω–µ –ø–æ–ª—É—á–∏–ª –î–ó
  - `mark_homework_delivered()` - –æ—Ç–º–µ—Ç–∫–∞ –¥–æ—Å—Ç–∞–≤–∫–∏

### 4. **–£–ª—É—á—à–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ —Ä–∞—Å—Å—ã–ª–∫–∏ –î–ó**
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π –ø–µ—Ä–µ–¥ –∑–∞–ø—Ä–æ—Å–æ–º —Å—Å—ã–ª–∫–∏
- –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π
- –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ–¥–Ω–∏–º –∏ —Ç–µ–º –∂–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º

---

## üìÇ –§–∞–π–ª—ã –¥–ª—è –∑–∞–º–µ–Ω—ã/—Å–æ–∑–¥–∞–Ω–∏—è

### 1. **–ó–∞–º–µ–Ω–∏—Ç—å** `crm2/handlers/admin/panel.py`
```python
# –ü–ê–¢–ß 1 (—Å—Ç—Ä–æ–∫–∏ 47-52):
# –ë—ã–ª–æ:
#     await cq.message.answer("–†–∞–∑–¥–µ–ª ¬´–î–æ–º–∞—à–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è¬ª –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ.")
# 
# –°—Ç–∞–ª–æ:
    from crm2.handlers.admin_homework import admin_homework_entry
    await admin_homework_entry(cq.message)
```

### 2. **–ó–∞–º–µ–Ω–∏—Ç—å** `crm2/handlers/admin_attendance.py`
```python
# –ü–ê–¢–ß 2 (—Å—Ç—Ä–æ–∫–∏ 167-186):
# –ë—ã–ª–æ:
#     curr = marks.get(user_id)  # None|'present'|'absent'|'expelled'
#     nxt = (
#         "present" if curr is None else
#         "absent" if curr == "present" else
#         "expelled" if curr == "absent" else  # ‚ö†Ô∏è –û–®–ò–ë–ö–ê
#         None
#     )
# 
# –°—Ç–∞–ª–æ:
    curr = marks.get(user_id)  # None|'present'|'absent'|'late'
    nxt = (
        "present" if curr is None else
        "absent" if curr == "present" else
        "late" if curr == "absent" else  # ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û
        None
    )
    
    # –ò –≤ msg:
    msg = {
        "present": "‚úÖ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤–æ–≤–∞–ª",
        "absent": "‚ùå –æ—Ç—Å—É—Ç—Å—Ç–≤–æ–≤–∞–ª",
        "late": "‚è∞ –æ–ø–æ–∑–¥–∞–ª"  # ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û
    }[nxt]
```

### 3. **–°–æ–∑–¥–∞—Ç—å** `crm2/services/attendance.py`
- –ü–æ–ª–Ω—ã–π –∫–æ–¥ –≤ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–µ "services/attendance.py (–Ω–æ–≤—ã–π —Ñ–∞–π–ª)"

### 4. **–ó–∞–º–µ–Ω–∏—Ç—å** `crm2/handlers/admin_homework.py`
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å FSM-–≤–µ—Ä—Å–∏—é —Å –ü–ê–¢–ß–ï–ú 3 –∏–∑ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–∞

### 5. **–ó–∞–º–µ–Ω–∏—Ç—å** `crm2/keyboards/admin_attendance.py`
```python
# –ü–ê–¢–ß 4 (—Ñ—É–Ω–∫—Ü–∏—è icon):
# –ë—ã–ª–æ:
#     return "‚úÖ" if st == "present" else "‚ùå" if st == "absent" else "‚õîÔ∏è" if st == "expelled" else "‚¨úÔ∏è"
#
# –°—Ç–∞–ª–æ:
    return (
        "‚úÖ" if st == "present" else
        "‚ùå" if st == "absent" else
        "‚è∞" if st == "late" else
        "‚¨úÔ∏è"
    )
```

---

## üöÄ –ü–æ—Ä—è–¥–æ–∫ –≤–Ω–µ–¥—Ä–µ–Ω–∏—è

### –®–∞–≥ 1: –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –ø–∞–ø–∫—É (–µ—Å–ª–∏ –Ω–µ—Ç)
```bash
mkdir -p crm2/services
touch crm2/services/__init__.py
```

### –®–∞–≥ 2: –ü—Ä–∏–º–µ–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
1. –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å `services/attendance.py` –∏–∑ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–∞
2. –ü—Ä–∏–º–µ–Ω–∏—Ç—å –ü–ê–¢–ß 1 –≤ `panel.py`
3. –ü—Ä–∏–º–µ–Ω–∏—Ç—å –ü–ê–¢–ß 2 –≤ `admin_attendance.py`
4. –ó–∞–º–µ–Ω–∏—Ç—å `admin_homework.py` –Ω–∞ FSM-–≤–µ—Ä—Å–∏—é (—Å –ü–ê–¢–ß–ï–ú 3)
5. –ü—Ä–∏–º–µ–Ω–∏—Ç—å –ü–ê–¢–ß 4 –≤ `keyboards/admin_attendance.py`

### –®–∞–≥ 3: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏–º–ø–æ—Ä—Ç—ã –≤ app.py
–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –ø–æ–¥–∫–ª—é—á–µ–Ω —Ä–æ—É—Ç–µ—Ä –∏–∑ FSM-–≤–µ—Ä—Å–∏–∏:
```python
from crm2.handlers import admin_homework
dp.include_router(admin_homework.router)
```

### –®–∞–≥ 4: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
1. –ó–∞–ø—É—Å—Ç–∏—Ç—å –ª–æ–∫–∞–ª—å–Ω–æ: `python app.py`
2. –û—Ç–∫—Ä—ã—Ç—å –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å: `/admin`
3. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —Ü–µ–ø–æ—á–∫—É:
   - ‚úÖ –ü–æ—Å–µ—â–∞–µ–º–æ—Å—Ç—å ‚Üí –æ—Ç–º–µ—Ç–∏—Ç—å –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É—é—â–∏—Ö
   - üìö –î–æ–º–∞—à–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è ‚Üí –≤—ã–±—Ä–∞—Ç—å –∑–∞–Ω—è—Ç–∏–µ ‚Üí –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –î–ó
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –î–ó –ø—Ä–∏—Ö–æ–¥–∏—Ç —Ç–æ–ª—å–∫–æ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤–æ–≤–∞–≤—à–∏–º
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –ø–æ–≤—Ç–æ—Ä–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ –Ω–µ –¥—É–±–ª–∏—Ä—É–µ—Ç

---

## üîç –ö–∞–∫ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–±–æ—Ç—É

### –¢–µ—Å—Ç 1: –ü–æ—Å–µ—â–∞–µ–º–æ—Å—Ç—å
```
1. /admin ‚Üí ‚úÖ –ü–æ—Å–µ—â–∞–µ–º–æ—Å—Ç—å
2. –í—ã–±—Ä–∞—Ç—å –∑–∞–Ω—è—Ç–∏–µ
3. –ö–ª–∏–∫–∞—Ç—å –Ω–∞ –∏–º–µ–Ω–∞:
   ‚¨úÔ∏è ‚Üí ‚úÖ ‚Üí ‚ùå ‚Üí ‚è∞ ‚Üí ‚¨úÔ∏è
4. –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –Ω–µ—Ç –æ—à–∏–±–æ–∫ –ë–î
```

### –¢–µ—Å—Ç 2: –†–∞—Å—Å—ã–ª–∫–∞ –î–ó
```
1. –û—Ç–º–µ—Ç–∏—Ç—å 2-3 —á–µ–ª–æ–≤–µ–∫–∞ –∫–∞–∫ "‚úÖ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤–æ–≤–∞–ª"
2. /admin ‚Üí üìö –î–æ–º–∞—à–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è
3. –í—ã–±—Ä–∞—Ç—å —Ç–æ –∂–µ –∑–∞–Ω—è—Ç–∏–µ
4. "üöÄ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –î–ó"
5. –î–æ–ª–∂–Ω–æ –ø–æ–∫–∞–∑–∞—Ç—å: "–ì–æ—Ç–æ–≤–æ –∫ –æ—Ç–ø—Ä–∞–≤–∫–µ: 2 –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π"
6. –í—Å—Ç–∞–≤–∏—Ç—å —Å—Å—ã–ª–∫—É, –æ—Ç–ø—Ä–∞–≤–∏—Ç—å
7. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤ —Ç–∞–±–ª–∏—Ü–µ homework_delivery
```

### SQL –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
```sql
-- –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ø—Ä–∏—Å—É—Ç—Å—Ç–≤–æ–≤–∞–≤—à–∏—Ö
SELECT u.full_name, a.status 
FROM attendance a
JOIN users u ON u.id = a.user_id
WHERE a.session_id = 1;

-- –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –¥–æ—Å—Ç–∞–≤–∫–∏ –î–ó
SELECT u.full_name, hd.link, hd.sent_at
FROM homework_delivery hd
JOIN users u ON u.id = hd.user_id
WHERE hd.session_id = 1;
```

---

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –º–æ–º–µ–Ω—Ç—ã

1. **–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–µ —Ç—Ä–µ–±—É–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π** - —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ—Å—Ç–∞—ë—Ç—Å—è –ø—Ä–µ–∂–Ω–µ–π
2. **–£–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä—É—é Command-–≤–µ—Ä—Å–∏—é** `admin_homework.py` –µ—Å–ª–∏ –æ–Ω–∞ –µ—Å—Ç—å –æ—Ç–¥–µ–ª—å–Ω–æ
3. **–°—Ç–∞—Ç—É—Å—ã –≤ –ë–î**: `present`, `absent`, `late` (–ù–ï `expelled`)
4. **FSM-–≤–µ—Ä—Å–∏—è** –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è –≤–≤–æ–¥–∞ —Å—Å—ã–ª–æ–∫ (–±–æ–ª–µ–µ user-friendly)

---

## üìä –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Ä–µ—à–µ–Ω–∏—è

```
[–ê–¥–º–∏–Ω –Ω–∞–∂–∏–º–∞–µ—Ç "‚úÖ –ü–æ—Å–µ—â–∞–µ–º–æ—Å—Ç—å"]
         ‚Üì
[–û—Ç–º–µ—á–∞–µ—Ç: user1=present, user2=present, user3=absent]
         ‚Üì
[–°–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ attendance —Å session_id]
         ‚Üì
[–ê–¥–º–∏–Ω ‚Üí "üìö –î–æ–º–∞—à–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è" ‚Üí –í—ã–±–∏—Ä–∞–µ—Ç –∑–∞–Ω—è—Ç–∏–µ]
         ‚Üì
[get_not_yet_delivered(session_id)]
  ‚Üí –ó–∞–ø—Ä–æ—Å: –∫—Ç–æ present –ò –µ—â—ë –Ω–µ—Ç –≤ homework_delivery
         ‚Üì
[–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç: "–ì–æ—Ç–æ–≤–æ –∫ –æ—Ç–ø—Ä–∞–≤–∫–µ: 2 –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π"]
         ‚Üì
[–ê–¥–º–∏–Ω –≤–≤–æ–¥–∏—Ç —Å—Å—ã–ª–∫—É]
         ‚Üì
[–†–∞—Å—Å—ã–ª–∫–∞ —Ç–æ–ª—å–∫–æ user1 –∏ user2]
         ‚Üì
[mark_homework_delivered() ‚Üí –∑–∞–ø–∏—Å—å –≤ homework_delivery]
         ‚Üì
[–ü–æ–≤—Ç–æ—Ä–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ ‚Üí "–í—Å–µ–º —É–∂–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ"]
```

---

## üéØ –†–µ–∑—É–ª—å—Ç–∞—Ç

‚úÖ –î–ó –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è **—Ç–æ–ª—å–∫–æ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤–æ–≤–∞–≤—à–∏–º**  
‚úÖ –ù–µ—Ç –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –æ—Ç–ø—Ä–∞–≤–æ–∫  
‚úÖ –£–¥–æ–±–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å —á–µ—Ä–µ–∑ FSM  
‚úÖ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –¥–æ—Å—Ç–∞–≤–æ–∫  
‚úÖ –ö–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ —Å—Ç–∞—Ç—É—Å—ã –ø–æ—Å–µ—â–∞–µ–º–æ—Å—Ç–∏  

–ì–æ—Ç–æ–≤–æ –∫ –¥–µ–ø–ª–æ—é! üöÄ